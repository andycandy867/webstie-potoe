{% extends 'base.html' %}

{% block body %}
	<div id="main-body">
		<article id="post-container">
			<div id="post-header">
				<div class="post-header">
					<img class="post-user-img" height="32" width="32" draggable="false" src="{{ url_for('static', filename='images/profile_pics/' + post.author.image_file) }}">

					<div class="post-header-info">
						<a href="{{ url_for('users.user_posts', username=post.author.username) }}">
							{{ post.author.username }}
						</a>
						<div id="post-followers-container">
							<span>{{ length(post.author.followers) }} Followers</span>
						</div>
					</div>

					{% if current_user.is_authenticated %}
						{% if current_user != post.author %}
							{% if author_followed %}
								<button class="following-button" id="follow-button" style="margin-left: 16px;">Following</button>
							{% else %}
								<button class="follow-button" id="follow-button" style="margin-left: 16px">Follow</button>
							{% endif %}
						{% endif %}
					{% else %}
						<a href="{{ url_for('users.signin', next=url_for('posts.post', post_id=post.id)|unquote) }}">
							<button class="follow-button" style="margin-left: 16px">Follow</button>
						</a>
					{% endif %}
				</div>

				{% if post.author == current_user %}
					<div>
						<button id="post-update-button" onclick="redirect(`{{ url_for('posts.update_post', post_id=post.id)|unquote }}`)">Update</button>
						<button id='post-delete-button'>Delete</button>
					</div>
				{% endif %}
			</div>

			<div class="post-title">
				<span>{{ post.title }}</span>
				{{ post_date_posted }}
			</div>

			{% with item = namespace(value=0) %}
				{% for text in splinted %}
					{% if is_media(text) == 'Yes' %}
						<img class="inserted-media" style="width: {{ get_media_size(text) }}%; 	margin: 24px 0;" src="{{ url_for('static', filename=rm_suffix(text)) }}">
					{% else %}
						{% if is_media(text) == 'Empty' %}
							<p></p>
						{% else %}
							<p class="post-content">{{ text }}</p>
						{% endif %}
					{% endif %}

					{% set item.value = item.value + 1 %}
				{% endfor %}
			{% endwith %}

			<div id="post-actions-container">
				<span id="post-views">{{ post.views }} views · {{ post_date_posted }}</span>

				{% if current_user.is_authenticated %}
					{% if post_liked_status == 'liked' %}
						<button id="post-like">
							<i class="post-like-img fa fa-thumbs-up"></i>
							<span>{{ length(post.post_likers) }}</span>
						</button>
						<button id="post-dislike">
							<i class="post-dislike-img fa fa-thumbs-o-down"></i>
							<span>{{ length(post.post_dislikers) }}</span>
						</button>
					{% elif post_liked_status == 'disliked' %}
						<button id="post-like">
							<i class="post-like-img fa fa-thumbs-o-up"></i>
							<span>{{ length(post.post_likers) }}</span>
						</button>
						<button id="post-dislike">
							<i class="post-dislike-img fa fa-thumbs-down"></i>
							<span>{{ length(post.post_dislikers) }}</span>
						</button>
					{% else %}
						<button id="post-like">
							<i class="post-like-img fa fa-thumbs-o-up"></i>
							<span>{{ length(post.post_likers) }}</span>
						</button>
						<button id="post-dislike">
							<i class="post-dislike-img fa fa-thumbs-o-down"></i>
							<span>{{ length(post.post_dislikers) }}</span>
						</button>
					{% endif %}

					<button id="post-save-opener">
						<i class="fa fa-list"></i>
						<span>Save</span>
					</button>
				{% else %}
					<button onclick="redirect(`{{ url_for('users.signin', next=url_for('posts.post', post_id=post.id)|unquote) }}`)">
						<i class="post-like-img fa fa-thumbs-o-up"></i>
						<span>{{ length(post.post_likers) }}</span>
					</button>
					<button onclick="redirect(`{{ url_for('users.signin', next=url_for('posts.post', post_id=post.id)|unquote) }}`)">
						<i class="post-dislike-img fa fa-thumbs-o-down"></i>
						<span>{{ length(post.post_dislikers) }}</span>
					</button>
					<button onclick="redirect(`{{ url_for('users.signin', next=url_for('posts.post', post_id=post.id)|unquote) }}`)">
						<i class="fa fa-list"></i>
						<span>Save</span>
					</button>
				{% endif %}
			</div>

			<div id="post-save-container">
				<div id="post-save-header">
					<h3>Save To...</h3>
					<button id="post-save-close">✖</button>
				</div>
				<div id="post-save-option-container-container">
					{% for collection in current_user.collections %}
						<div class="post-save-option-container">
							<input id="{{ collection.id }}" type="checkbox">
							<button>{{ collection.name }}</button>
						</div>
					{% endfor %}
				</div>
				<button id="post-save-create-new">
					<i class="fa fa-plus"></i>
					Create New Playlist
				</button>
			</div>

			<div id="comment-section-container">
				<div id="comment-section-header">
					<h3>{{ comments.count() }} Comments</h3>
					<button id="sort-button">
						<i class="fa fa-sort"></i>
						<span>SORT BY</span>
					</button>
				</div>

				<div id="comment-section">
					<div id="comment-create">
						<img class="comment-account-img" height="36" width="36" draggable="false" src="{{ image_file }}">
						<form id="comment-create-form" method="POST" action="{{ url_for('posts.comment', post_id=post.id) }}">
							{{ post_comment_form.hidden_tag() }}
							{% if current_user.is_authenticated %}
								{{ post_comment_form.content(class="comment-input", placeholder="Add a comment...") }}
								<div id="comment-create-options" style="display: none;">
									<button id="comment-create-cancel-button" type="button">Cancel</button>
									<button id="comment-create-comment-button">Comment</button>
								</div>
							{% else %}
								<input class="comment-input" onclick="redirect(`{{ url_for('users.signin', next=url_for('posts.post', post_id=post.id)|unquote) }}`)" placeholder="Add a comment...">
							{% endif %}
						</form>
					</div>

					{% for comment in comments %}
						{% if not comment.comment_id %}
							<div class="comment" data-id='{{ comment.id}}'>
								<a href="{{ url_for('users.user_posts', username=comment.author.username) }}">
									<img class="comment-account-img" height="32" width="32" draggable="false" src="{{ url_for('static', filename='images/profile_pics/' + post.author.image_file) }}">
								</a>

								<div class="comment-body">
									<div class="comment-body-header">
										<a class="comment-author" style="margin-right: 5px" href="{{ url_for('users.user_posts', username=comment.author.username) }}">
											{{ comment.author.username }}
										</a>

										<span class="comment-date-posted">{{ comment.date_posted.strftime('%Y-%m-%d') }}</span>
									</div>

									<p class="comment-body-content">{{ comment.content }}</p>

									<div class="comment-actions-container">
										{% if current_user.is_authenticated %}
											{% if comment_like_check(comment) == 'True' %}
												<button class="comment-like">
													<i class="comment-like-img fa fa-thumbs-up"></i>
													<span>{{ length(comment.comment_likers) }}</span>
												</button>
												<button class="comment-dislike">
													<i class="comment-dislike-img fa fa-thumbs-o-down"></i>
													<span>{{ length(comment.comment_dislikers) }}</span>
												</button>
											{% elif not comment_like_check(comment) %}
												<button class="comment-like">
													<i class="comment-like-img fa fa-thumbs-o-up"></i>
													<span>{{ length(comment.comment_likers) }}</span>
												</button>
												<button class="comment-dislike">
													<i class="comment-dislike-img fa fa-thumbs-down"></i>
													<span>{{ length(comment.comment_dislikers) }}</span>
												</button>
											{% else %}
												<button class="comment-like">
													<i class="comment-like-img fa fa-thumbs-o-up"></i>
													<span>{{ length(comment.comment_likers) }}</span>
												</button>
												<button class="comment-dislike">
													<i class="comment-dislike-img fa fa-thumbs-o-down"></i>
													<span>{{ length(comment.comment_dislikers) }}</span>
												</button>
											{% endif %}

											<button class="comment-reply">REPLY</button>
										{% else %}
											<button onclick="redirect(`{{ url_for('users.signin', next=url_for('posts.post', post_id=post.id)|unquote) }}`)">
												<i class="post-like-img fa fa-thumbs-o-up"></i>
												<span>{{ length(comment.comment_likers) }}</span>
											</button>

											<button onclick="redirect(`{{ url_for('users.signin', next=url_for('posts.post', post_id=post.id)|unquote) }}`)">
												<i class="post-dislike-img fa fa-thumbs-o-down"></i>
												<span>{{ length(comment.comment_dislikers) }}</span>
											</button>

											<button class="comment-reply" onclick="redirect(`{{ url_for('users.signin', next=url_for('posts.post', post_id=post.id)|unquote) }}`)">
												REPLY
											</button>
										{% endif %}
									</div>

									<!-- Comment Form -->
									<div class="comment-create" style="display: none;">
										<img class="comment-account-img" height="36" width="36" draggable="false" src="{{ image_file }}"/>
										<form id="comment-create-form" method="POST" action="{{ url_for('posts.comment', post_id=post.id, comment_id=comment.id) }}">
											{{ comment_comment_form.hidden_tag() }}
											{% if current_user.is_authenticated %}
												{{ comment_comment_form.content(class="comment-input", placeholder="Reply...") }}
												<div style="display: block;">
													<button class="comment-reply-cancel-button" type="button">Cancel</button>
													<button class="comment-reply-submit-button">Comment</button>
												</div>
											{% else %}
												<a href="{{ url_for('users.signin', next=url_for('posts.post', post_id=post.id)|unquote) }}">
													<input class="comment-input" placeholder="Reply...">
												</a>
											{% endif %}
										</form>
									</div>

									{% with comment_reply_count = namespace(value=0) %}
										{% for comment_reply in comments %}
											{% if comment_reply.comment_id == comment.id %}
												{% set comment_reply_count.value = comment_reply_count.value + 1 %}
											{% endif %}
										{% endfor %}

										{% if comment_reply_count.value > 0 %}
											<button class="comment-view-reply">
												<i class="comment-view-reply-image fa fa-caret-down"></i>
												View {{ comment_reply_count.value }} replies
											</button>

											<div class="comment-replies" style="display: none;">
												{% for comment_reply in comments %}
													{% if comment_reply.comment_id == comment.id %}
														<div class="comment" data-id='{{ comment_reply.id}}'>
															<a href="{{ url_for('users.user_posts', username=comment_reply.author.username) }}">
																<img class="comment-account-img" height="32" width="32" draggable="false" src="{{ url_for('static', filename='images/profile_pics/' + post.author.image_file) }}">
															</a>
															
															<div class="comment-body">
																<div class="comment-body-header">
																	<a class="comment-author" style="margin-right: 5px" href="{{ url_for('users.user_posts', username=comment_reply.author.username) }}">
																		{{ comment_reply.author.username }}
																	</a>
																	
																	<span class="comment-date-posted">{{ comment_reply.date_posted.strftime('%Y-%m-%d') }}</span>
																</div>
															
																<p class="comment-body-content">{{ comment_reply.content }}</p>

																<div class="comment-actions-container">
																	{% if current_user.is_authenticated %}
																		{% if comment_like_check(comment_reply) == 'True' %}
																			<button class="comment-like">
																				<i class="comment-like-img fa fa-thumbs-up"></i>
																				<span>{{ length(comment_reply.comment_likers) }}</span>
																			</button>
																			<button class="comment-dislike">
																				<i class="comment-dislike-img fa fa-thumbs-o-down"></i>
																				<span>{{ length(comment_reply.comment_dislikers) }}</span>
																			</button>
																		{% elif not comment_like_check(comment_reply) %}
																			<button class="comment-like">
																				<i class="comment-like-img fa fa-thumbs-o-up"></i>
																				<span>{{ length(comment_reply.comment_likers) }}</span>
																			</button>
																			<button class="comment-dislike">
																				<i class="comment-dislike-img fa fa-thumbs-down"></i>
																				<span>{{ length(comment_reply.comment_dislikers) }}</span>
																			</button>
																		{% else %}
																			<button class="comment-like">
																				<i class="comment-like-img fa fa-thumbs-o-up"></i>
																				<span>{{ length(comment_reply.comment_likers) }}</span>
																			</button>
																			<button class="comment-dislike">
																				<i class="comment-dislike-img fa fa-thumbs-o-down"></i>
																				<span>{{ length(comment_reply.comment_dislikers) }}</span>
																			</button>
																		{% endif %}

																		<button class="comment-reply">Reply</button>
																	{% else %}
																		<button onclick="redirect(`{{ url_for('users.signin', next=url_for('posts.post', post_id=post.id)|unquote) }}`)">
																			<i class="post-like-img fa fa-thumbs-o-up"></i>
																			<span>{{ length(comment_reply.comment_likers) }}</span>
																		</button>

																		<button onclick="redirect(`{{ url_for('users.signin', next=url_for('posts.post', post_id=post.id)|unquote) }}`)">
																			<i class="post-dislike-img fa fa-thumbs-o-down"></i>
																			<span>{{ length(comment_reply.comment_dislikers) }}</span>
																		</button>

																		<button class="comment-reply" onclick="redirect(`{{ url_for('users.signin', next=url_for('posts.post', post_id=post.id)|unquote) }}`)">
																			REPLY
																		</button>
																	{% endif %}
																</div>

																<!-- Comment Form -->
																<div class="comment-create" style="display: none;">
																	<img class="comment-account-img" height="36" width="36" draggable="false" src="{{ image_file }}"/>

																	<form id="comment-create-form" method="POST" action="{{ url_for('posts.comment', post_id=post.id, comment_id=comment_reply.id) }}">
																		{{ comment_comment_form.hidden_tag() }}
																		{% if current_user.is_authenticated %}
																			{{ comment_comment_form.content(class="comment-input", placeholder="Reply...") }}
																			<div>
																				<button class="comment-reply-cancel-button" type="button">Cancel</button>
																				<button class="comment-reply-submit-button">Comment</button>
																			</div>
																		{% else %}
																			<a href="{{ url_for('users.signin', next=url_for('posts.post', post_id=post.id)|unquote) }}">
																				<input class="comment-input" placeholder="Reply...">
																			</a>
																		{% endif %}
																	</form>
																</div>
															</div>
														</div>
													{% endif %}
												{% endfor %}
											</div>
										{% endif %}
									{% endwith %}
								</div>
							</div>
						{% endif %}
					{% endfor %}
				</div>
			</div>
		</article>

		<!-- Modal -->
		<div id="post-delete-modal" style="display: none;">
			<div id="post-delete-modal-header">
				<h3>Are you sure you want to delete the post?</h3>
				<p>The post will be unrecoverable</p>
			</div>

			<div id="post-delete-modal-body">
				<button id="post-delete-modal-close">Cancel</button>
				<button id="post-delete-modal-submit">Delete</button>
			</div>
		</div>
	</div>
{% endblock %}